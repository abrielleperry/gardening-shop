<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/checkoutcss.css" />
    <title>Shopping Cart</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
  
    <title>
      Welcome to BloomHouse Shopping Cart. 
    </title>

    <link rel="stylesheet" href="/static/css/styles.css" />
    <!-- FONTAWESOME -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- BOOTSTRAP -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- GOOGLE FONT -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
      rel="stylesheet"
    />
    <!-- SPLIDE -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@splidejs/splide@3.6.9/dist/css/splide.min.css"
    />
</head>
<body>
    <header role="banner">
        <nav class="navbar navbar-expand-lg" role="navigation">
            <div class="container-fluid mx-4">
            <a class="navbar-brand" href="index.html">
                </img
                src="/static/images/logos/BHIconWhite.png"
                alt="Bloomhouse logo icon of house and flowers"
                width="90px"
                class="house-icon"
                loading="eager"
                />
                <img
                src="/static/images/logos/BHWhite.png"
                alt="Bloomhouse logo text"
                width="200px"
                class="bh-logo"
                loading="eager"
                />
            </a>
            <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent"
                aria-expanded="false"
                aria-label="Toggle navigation"
            >
                <i class="fa-solid fa-bars" style="color: #ffffff"></i>
            </button>
            <div
                class="collapse navbar-collapse justify-content-end"
                id="navbarSupportedContent"
            >
                <ul class="navbar-nav mb-2 mb-lg-0 gap-5">
                <li class="nav-item">
                    <a href="#product-page" class="nav-link">SHOP PLANTS</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link">PLANT CARE</a>
                </li>
                <li class="nav-item">
                    <a href="#about-us" class="nav-link">ABOUT US</a>
                </li>
                <li class="nav-item">
                    <a href="cart.html" class="nav-link">
                    <i class="fa-solid fa-cart-shopping"></i>
                    </a>
                </li>
                </ul>
            </div>
            </div>
        </nav>
        <h1>Your Gardening Cart</h1>
    </header>
    <main>
        <form action="/create-checkout-session" method="POST">
            <table id="cart-table" border="1">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Cart items will be dynamically inserted here -->
                </tbody>
            </table>
            <p id="cart-empty" style="display: none;">Your cart is empty.</p>
            <p>Total Amount: $<span id="cart-total">0.00</span></p>
            <input type="hidden" name="total_amount" id="total_amount" value="0">
            <button type="submit" id="checkout-button">Proceed to Checkout</button>
        </form>
        <br>
        <br>
    </main>
        <!--FOOTER-->
    <footer role="footer">
      <div class="footer-container container-fluid row">
        <div class="footer-logo col-5">
          <img
            src="/static/images/BloomHouseTogether.png"
            alt="BloomHouse logo"
            loading="eager"
          />
          <p>Where Passionate Gardeners Find Their Perfect Plants</p>
        </div>
        <div class="contact-social col-3">
          <h3>Contact Us</h3>
          <p>918-555-5419</p>
          <p>574 East Jackson Ave.</p>
          <p>Mesa, AZ 85203</p>
          <div class="socials">
            <a href="#">
              <img
                src="/static/images/social-media/facebook.png"
                alt="Facebook icon"
                loading="eager"
              />
            </a>
            <a href="#">
              <img
                src="/static/images/social-media/instagram.png"
                alt="Instagram icon"
                loading="eager"
              />
            </a>
            <a href="#">
              <img
                src="/static/images/social-media/tik-tok.png"
                alt="TikTok icon"
                loading="eager"
              />
            </a>
          </div>
        </div>
        <div class="signup-news col-4">
          <form>
            <div class="mb-3">
              <label for="exampleInputEmail1" class="form-label"
                >Stay Informed with Our Latest News and Special Offers</label
              >
              <input
                type="email"
                class="form-control"
                id="exampleInputEmail1"
                aria-describedby="emailHelp"
                placeholder="Email address"
              />
            </div>
            <button aria-label="submit email button" type="submit" class="btn">
              Submit
            </button>
          </form>
        </div>
      </div>
    </footer>
    <script>
        function getCart() {
            const cart = getCookie('cart');
            return cart ? JSON.parse(cart) : [];
        }
        // Function to get a cookie by name
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(";");
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == " ") c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
    </script>
    <script>
    function loadCart() {
                const cartCookie = getCookie('cart');
                    // Ensure cartCookie is parsed as an array
                let cart = [];
                try {
                    cart = cartCookie ? JSON.parse(cartCookie) : [];
                    
                } catch (e) {
                    console.error("Error parsing cart cookie:", e);
                    cart = [];
                }


                console.log("Parsed cart:", cart);
                console.log("Type of cart:", typeof cart);
                console.log("Is cart an array?:", Array.isArray(cart));

                const tableBody = document.getElementById('cart-table').getElementsByTagName('tbody')[0];
                const cartEmptyMessage = document.getElementById('cart-empty');
                const cartTotalElement = document.getElementById('cart-total');
                const totalAmountInput = document.getElementById('total_amount');
                let totalAmount = 0;
                // Clear existing rows
                tableBody.innerHTML = '';

                if (cart.length === 0) {
                    cartEmptyMessage.style.display = 'block';
                } else {
                    cartEmptyMessage.style.display = 'none';
                    cart.forEach((item, index) => {
                        const row = tableBody.insertRow();
                        row.insertCell(0).textContent = item.commonName;
                        row.insertCell(1).textContent = `$${((item.price)).toFixed(2)}`;
                        //Quantity
                        const quantityCell = row.insertCell(2);
                        const quantityInput = document.createElement('input');
                        quantityInput.type = 'number';
                        quantityInput.value = item.quantity;
                        quantityInput.min = 1;

                        quantityInput.addEventListener('change', function() {
                            updateQuantity(index, quantityInput.value);
                        });
                        quantityCell.appendChild(quantityInput);
                        //total price
                        const totalCell = row.insertCell(3);
                        totalCell.textContent = `$${((item.price * item.quantity)).toFixed(2)}`;

                        //Action
                        const actionCell = row.insertCell(4);
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Remove';
                        deleteButton.addEventListener('click', function() {
                            deleteItem(index);
                        });
                        
                        actionCell.appendChild(deleteButton);
                        //row.insertCell(5).textContent = item.quantity;
                        //row.insertCell(5).textContent = `$${((item.price * item.quantity)).toFixed(2)}`;
                        const totalItemPrice = item.price * item.quantity;
                        
                        totalAmount += totalItemPrice;
                        console.log(totalAmount);
                    });
                }
                // Update the total amount displayed
                cartTotalElement.textContent = (totalAmount).toFixed(2);
                // Set the hidden input value for the total amount
                totalAmountInput.value = totalAmount;
            }

        function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function saveCart(cart){
            console.log("saving cart", cart)
            setCookie('cart', JSON.stringify(cart), 7);
            console.log("cookie after save:", document.cookie);
        }

        function updateQuantity(index, quantity) {
            const cartCookie = getCookie('cart');
            let cart = cartCookie ? JSON.parse(cartCookie) : [];

            //ensure qty is integer
            cart[index].quantity = parseInt(quantity, 10);
            //update
            cart[index].quantity = quantity;

            saveCart(cart);
            loadCart(cart);
        }
        
        function deleteItem(index) {
            const cartCookie = getCookie('cart');
            let cart = cartCookie  ? JSON.parse(cartCookie) : [];

            cart.splice(index, 1);  //remove item at index
            saveCart(cart);
            loadCart(cart);
        }
        
        // Load the cart when the page loads
        window.onload = loadCart;
    </script>
    
</body>
</html>
